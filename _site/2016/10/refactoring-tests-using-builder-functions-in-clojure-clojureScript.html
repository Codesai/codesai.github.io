<!DOCTYPE html>
<html class="no-js">
  <head>

    <meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<title>Refactoring tests using builder functions in Clojure/ClojureScript</title>
<meta name='description' content=''>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

<!-- CSS -->
<link rel='stylesheet' href='/css/owl.carousel.css' />
<link rel='stylesheet' href='/css/bootstrap.min.css' />
<link rel='stylesheet' href='/css/font-awesome.min.css' />
<link rel='stylesheet' href='/css/airspace.css' />
<link rel='stylesheet' href='/css/style.css' />
<link rel='stylesheet' href='/css/ionicons.min.css' />
<link rel='stylesheet' href='/css/animate.css' />
<link rel='stylesheet' href='/css/responsive.css' />
<link rel='stylesheet' href='/css/syntax.css' />
<link rel='stylesheet' href='/css/blog.css' />

<!-- Js -->
<script src='/js/vendor/jquery-1.10.2.min.js'></script>
<script src='/js/bootstrap.min.js'></script>
<script src='/js/owl.carousel.min.js'></script>
<script src='/js/owl.carousel.min.js'></script>
<script src='/js/plugins.js'></script>
<script src='/js/min/waypoints.min.js'></script>
<script src='/js/jquery.counterup.js'></script>
<script src='/js/js-cookie.js'></script>
<script src='/js/Cookie.js'></script>
<script src='/js/main.js'></script>

<script>
function saveCookie() {
  Cookie('codesai').save();
  $('.cookie-message').hide();
}

$(document).ready(function() {
  if (Cookie('codesai').exists()) {
    return;
  } 
  $('.cookie-message').show();
});
</script>





  </head>
  <body>


    <!-- Header Start -->
<header>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <!-- header Nav Start -->
                <nav class="navbar navbar-default">
                    <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a class="navbar-brand" href="/">
                                <img src="/img/logo.png" alt="Logo">
                            </a>
                        </div>
                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="/">Inicio</a></li>
                                <li><a href="/#team">Equipo</a></li>
                                <li><a href="/clients/">Clientes</a></li>
                                <li><a href="/curso-de-tdd">Formación</a></li>
                                <li><a href="/blog">Blog</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </div>
        </div>
    </div>
</header>

<div class="cookie-message">
    <div class="container">
        <div class="row">
            <div class="col-md-offset-2 col-md-7">
                <p>Hacemos uso de cookies para recoger estadísticas de navegación. Si continúa navegando está dando su consentimiento y acepta nuestra <a href="/cookie-policy">política de cookies</a>.</p>
            </div>
            <div class="col-md-1 accept-button">
                <button class="btn btn-warning" onclick="saveCookie();">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- header close -->



    <div class="post">
  <section id="intro" style="border: 1px dotted #ddd;">
    <div class="container">
      <div class="row">
        <div>
          <div class="block">
            <h1>Refactoring tests using builder functions in Clojure/ClojureScript</h1>
            <div class="post-info-wrapper">
              <p class="italic">Publicado por <span class="bold">Manuel Rivero</span> el <span class="bold">08/10/2016</span></p>
            </div>
            <hr />
            <p><p>Using literals in your tests can have some advantages, such as, readability and traceability. 
<br /><br />
While this is true when the data are simple, it’s less so when the data are nested, complex structures.
In that case, using literals can hinder refactoring and thus become an obstacle to adapting to changes.
<br /><br />
The problem with using literals for complex, nested data is that the knowledge about how to build such data is spread all over the tests. There are many tests that know about the representation of the data.
<br /><br />
In that scenario, nearly any change in the representation of those data will have a big impact on the tests code 
because it will force us to change many tests.
<br /><br />
This is an example of a test using literals, (from a ClojureScript application
using <a href="https://github.com/Day8/re-frame">re-frame</a>, I’m developing with <a href="https://twitter.com/zesc">Francesc</a>), 
to prepare the <i>application state</i> (usually called <i>db</i> in <a href="https://github.com/Day8/re-frame">re-frame</a>):
<br /><br />
<script src="https://gist.github.com/trikitrok/50a48e7899ba820ca140835112e8ad0b.js"></script>
As you can see, this test knows to much about the structure of <i>db</i>. 
<br /><br />
There were many other tests doing something similar at some nesting level of the <i>db</i>. 
<br /><br />
To make things worse, at that moment, we were still learning a lot about the domain, so the structure of the <i>db</i> was suffering changes with every new thing we learned. 
<br /><br />
The situation was starting to be painful, since any refactoring provoke many changes in the tests, so we decided to fix it.
<br /><br />
What we wanted was a way to place all the knowledge about
the representation of the <i>db</i> in just one place (i.e., remove duplication),
so that, in case we needed to change that representation, the impact of the change would be
absorbed by changing only one place.
<br /><br />
A nice way of achieving this goal in object-oriented code, and at the same time making
your tests code more readable, is by using <a href="http://www.natpryce.com/articles/000714.html">test data builders</a> which use the <a href="https://en.wikipedia.org/wiki/Builder_pattern">builder pattern</a>, but how can we do these <i>builders</i> in Clojure?
<br /><br />
<a href="https://aphyr.com/posts/321-builders-vs-option-maps">Option maps or function with keyword arguments are a nice alternative</a> to traditional builders in dynamic languages such as Ruby or Python.
<br /><br />
<a href="http://stackoverflow.com/questions/12633670/whats-the-clojure-way-to-builder-pattern">In Clojure we can compose <i>functions with keyword arguments</i> to get very readable builders</a> that also hide the representation of the data.
<br /><br />
We did TDD to write these <i>builder functions</i>. These are the tests for one of them, the <i>db builder</i>:
<br /><br />
<script src="https://gist.github.com/trikitrok/093f10a3af82422d1eff8a83323aa7a7.js"></script>
and this is the <i>db builder</i> code:
<br /><br />
<script src="https://gist.github.com/trikitrok/1832b30d4a397acc0d24c3659edf1161.js"></script>
which is using <a href="http://clojure.org/guides/destructuring">associative destructuring</a> on the function’s optional arguments to have a function with keyword arguments, and creating proper default values using the <i>:or keyword</i> (have a look at the <a href="https://gist.github.com/trikitrok/e24b0a8ecacf8c1ae726">material of a talk about destructuring I did some time ago</a> for <a href="http://www.meetup.com/ClojureBCN/">Clojure Barcelona Developers community</a>).
<br /><br />
After creating <i>builder functions</i> for some other data used in the project, our test started to read better and to be robust against changes in the structure of <i>db</i>.
<br /><br />
For instance, this is the code of the test I showed at the beginning of the post, but now using <i>builder functions</i> instead of literals:
<br /><br />
<script src="https://gist.github.com/trikitrok/e8a8244ebc0fa82352bb8003a82da077.js"></script>
which not only hides the representation of <i>db</i> but also eliminates details that are not used in particular tests, while still being as easy to read, if not easier, than the version using literals.
<br /><br />
We have seen how, by composing <i>builder functions</i> and using them in our tests, we managed to reduce
the surface of the impact that changes in the representation of data might have on our tests. 
<i>Builder functions</i> absorb the impact of those changes, and enable faster refactoring, and, by doing so, enable adapting to changes faster.</p>
</p>
            
             
              <p>Publicado originalmente en el blog de <a href="http://garajeando.blogspot.com.es/2016/10/using-builders-to-remove-duplication-in.html">Manuel Rivero</a>.</p>
            

            
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
<p class="center-text" style="padding: 30px;">
  <a href="/blog">Volver al blog</a>
</p>











    <footer>
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12">
                <div class="logo">
                    <img src="/img/logo.png">
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="contact">
                    <i class="ion-android-mail"></i>
                    <script type="text/javascript">// <![CDATA[
                        var a='contact', b='codesai', c='.com'; document.write('<a hre'+'f="mai'+'lto:' + a +'@' + b + c + '">'); document.write(a +'@' + b+c+'</a>');
                    // ]]&gt;</script>

                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="social">
                    <a href="https://twitter.com/codesaidev"><i class="ion-social-twitter"></i></a>
                    <a href="https://www.linkedin.com/company/codesai"><i class="ion-social-linkedin"></i></a>
                    <a href="https://codesai.aerobatic.io/atom.xml"><i class="ion-social-rss"></i></a>
                </div>
            </div>
        </div>
    </div>
</footer>

    </body>
</html>
